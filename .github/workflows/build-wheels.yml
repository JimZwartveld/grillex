name: Build and Publish Wheels

on:
  push:
    branches:
      - main
      - master
      - development
      - release
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      publish_target:
        description: 'Where to publish'
        required: true
        default: 'none'
        type: choice
        options:
          - none
          - dev
          - prod

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # Build wheels for Linux only (self-hosted)
  # Windows and macOS disabled to save GitHub Actions minutes
  # =============================================================================
  build_wheels:
    name: Build wheels on Linux
    runs-on: self-hosted
    # Matrix disabled - only building on self-hosted Linux
    # strategy:
    #   fail-fast: false
    #   matrix:
    #     # Windows and macOS disabled to save GitHub Actions minutes
    #     os: [ubuntu-latest]
    #     # os: [ubuntu-latest, windows-latest, macos-14]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for setuptools_scm
          submodules: true

      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install cibuildwheel
        run: |
          ${{ steps.setup-python.outputs.python-path }} -m pip install --upgrade pip
          ${{ steps.setup-python.outputs.python-path }} -m pip install cibuildwheel==2.21.0

      - name: Build wheels
        run: ${{ steps.setup-python.outputs.python-path }} -m cibuildwheel --output-dir wheelhouse
        env:
          # Build for Python 3.11, 3.12, 3.13
          CIBW_BUILD: "cp311-* cp312-* cp313-*"
          # Skip 32-bit builds and musllinux
          CIBW_SKIP: "*-win32 *-manylinux_i686 *-musllinux_*"
          # x86_64 only to save build time
          CIBW_ARCHS_LINUX: x86_64
          # Test that the package imports correctly
          CIBW_TEST_COMMAND: >
            python -c "import grillex; print('Grillex imported successfully')"
          # Install numpy for testing
          CIBW_TEST_REQUIRES: numpy

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux
          path: ./wheelhouse/*.whl
          retention-days: 7

  # =============================================================================
  # Build source distribution
  # =============================================================================
  build_sdist:
    name: Build source distribution
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Add Python to PATH
        run: echo "${{ env.pythonLocation }}/bin" >> $GITHUB_PATH

      - name: Install build dependencies
        run: pip install build

      - name: Build sdist
        run: python -m build --sdist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz
          retention-days: 7

  # =============================================================================
  # Test the built wheels (Linux only)
  # =============================================================================
  test_wheels:
    name: Test wheel on Linux / Python ${{ matrix.python }}
    needs: build_wheels
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        python: ['3.11', '3.12', '3.13']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Add Python to PATH
        run: echo "${{ env.pythonLocation }}/bin" >> $GITHUB_PATH

      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          name: wheels-linux
          path: wheelhouse

      - name: Install wheel
        run: |
          PYTHON_VERSION=$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")
          echo "Looking for wheel: Python=$PYTHON_VERSION"
          ls -la wheelhouse/

          WHEEL=$(find wheelhouse -name "grillex-*${PYTHON_VERSION}*manylinux*x86_64*.whl" | head -1)

          if [[ -z "$WHEEL" ]]; then
            echo "Error: No compatible wheel found"
            exit 1
          fi

          echo "Installing: $WHEEL"
          pip install "$WHEEL"
          pip install pytest numpy scipy pyyaml pydantic

      - name: Run tests
        run: |
          pytest tests/python -v -x --ignore=tests/python/test_gmsh*.py -k "not slow"

  # =============================================================================
  # Publish to Development PyPI (on push to development branch)
  # =============================================================================
  publish_dev:
    name: Publish to Dev PyPI
    needs: [build_wheels, build_sdist, test_wheels]
    runs-on: self-hosted
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/development') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_target == 'dev')

    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist

      - name: List distribution files
        run: ls -la dist/

      - name: Install twine
        run: pip install twine

      - name: Publish to Dev PyPI
        env:
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          PYPI_USERNAME: ${{ secrets.PYPI_USERNAME }}
          PYPI_USERNAME: ${{ secrets.PYPI_USERNAME }}
          PYPI_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
        run: |
          echo "Publishing to Dev PyPI (pypi-dev.jimzwartveld.com)"

          for file in dist/*; do
            echo "Uploading: $file"
            curl -X POST \
              -H "CF-Access-Client-Id: ${CF_ACCESS_CLIENT_ID}" \
              -H "CF-Access-Client-Secret: ${CF_ACCESS_CLIENT_SECRET}" \
              -u "${PYPI_USERNAME}:${PYPI_PASSWORD}" \
              -F ":action=file_upload" \
              -F "content=@${file}" \
              "https://pypi-dev.jimzwartveld.com/"
          done

  # =============================================================================
  # Publish to Production PyPI (on push to release branch or tags)
  # =============================================================================
  publish_prod:
    name: Publish to Prod PyPI
    needs: [build_wheels, build_sdist, test_wheels]
    runs-on: self-hosted
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/release') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_target == 'prod')

    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist

      - name: List distribution files
        run: ls -la dist/

      - name: Install twine
        run: pip install twine

      - name: Publish to Prod PyPI
        env:
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          PYPI_USERNAME: ${{ secrets.PYPI_USERNAME }}
          PYPI_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
        run: |
          echo "Publishing to Prod PyPI (pypi-prod.jimzwartveld.com)"

          for file in dist/*; do
            echo "Uploading: $file"
            curl -X POST \
              -H "CF-Access-Client-Id: ${CF_ACCESS_CLIENT_ID}" \
              -H "CF-Access-Client-Secret: ${CF_ACCESS_CLIENT_SECRET}" \
              -u "${PYPI_USERNAME}:${PYPI_PASSWORD}" \
              -F ":action=file_upload" \
              -F "content=@${file}" \
              "https://pypi-prod.jimzwartveld.com/"
          done

      - name: Also publish to Dev PyPI (keep dev aligned with prod)
        env:
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          PYPI_USERNAME: ${{ secrets.PYPI_USERNAME }}
          PYPI_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
        run: |
          echo "Publishing to Dev PyPI (pypi-dev.jimzwartveld.com)"

          for file in dist/*; do
            echo "Uploading: $file"
            curl -X POST \
              -H "CF-Access-Client-Id: ${CF_ACCESS_CLIENT_ID}" \
              -H "CF-Access-Client-Secret: ${CF_ACCESS_CLIENT_SECRET}" \
              -u "${PYPI_USERNAME}:${PYPI_PASSWORD}" \
              -F ":action=file_upload" \
              -F "content=@${file}" \
              "https://pypi-dev.jimzwartveld.com/"
          done
