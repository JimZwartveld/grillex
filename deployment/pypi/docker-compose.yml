# =============================================================================
# Private PyPI Server using devpi
# =============================================================================
#
# devpi provides:
# - Private package hosting
# - PyPI caching/mirroring (faster installs)
# - Multiple indices (dev, staging, prod)
# - User authentication
#
# Usage:
#   docker-compose -f deployment/pypi/docker-compose.yml up -d
#
# Access:
#   Web UI: http://localhost:3141
#   PyPI:   http://localhost:3141/root/pypi/+simple/
# =============================================================================

version: '3.8'

services:
  devpi:
    image: devpi/devpi:latest
    container_name: devpi-server
    restart: unless-stopped

    ports:
      - "3141:3141"

    volumes:
      - devpi-data:/var/lib/devpi

    environment:
      # Initial root password (change after first login!)
      - DEVPI_ROOT_PASSWORD=changeme
      # Server settings
      - DEVPI_HOST=0.0.0.0
      - DEVPI_PORT=3141

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3141/+status"]
      interval: 30s
      timeout: 10s
      retries: 3

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # Optional: nginx reverse proxy with SSL
  nginx:
    image: nginx:alpine
    container_name: devpi-nginx
    restart: unless-stopped

    ports:
      - "443:443"
      - "80:80"

    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certs:/etc/nginx/certs:ro

    depends_on:
      - devpi

    profiles:
      - ssl  # Only start with: docker-compose --profile ssl up

volumes:
  devpi-data:
